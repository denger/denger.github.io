<html>
  <head>
    <meta content='MyBatis+Spring 基于接口编程的原理分析 - Denger Notes：生活、技术、思考' property='og:title' />
    <title>MyBatis+Spring 基于接口编程的原理分析 - Denger Notes：生活、技术、思考</title>
    <link href='/images/fav.png' rel='shortcut icon'>
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css' />
<link href='/stylesheets/style.css' rel='stylesheet' type='text/css' />
<link href='/stylesheets/syntax.css' rel='stylesheet' type='text/css' />
<link href='/stylesheets/responsive.css' rel='stylesheet' type='text/css' />
<!-- - -->
<script src='/javascripts/jquery.js' type='text/javascript'></script>
<script src='/javascripts/pd.js' type='text/javascript'></script>
<script src='/javascripts/basics.js' type='text/javascript'></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<!-- - -->
<meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'>
<meta content='text/html; charset=utf-8' http-equiv='content-type' />
<meta content="/og.png" property="og:image" />
<meta content="" property="fb:app_id" />

  <meta content='/sourcecode/2011/05/27/mybatis-and-spring-interface-integrated/' property='og:url' />
  <meta content="整合Spring3及MyBatis3对于整合Spring及Mybatis不作详细介绍，可以参考： MyBatis 3 User Guide Simplified Chinese.pdf，贴出我的主要代码如下：package org.d..." property='og:description' />
  <meta content="article" property="og:type" />

<!-- - -->
<script type='text/javascript'>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', '']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  //]]>
</script>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

  </head>
  <body>
    <header>
<a id="go-back-home" href="/"><img src="/images/scribble.png" alt="scribble" width="53" height="59"/></a>
<p>Denger Notes：生活、技术、思考</p>
</header>

    <div id='container'>
      <div class="block">
  
    <a target="_blank"
       class="main" 
       href="/about">
       About
     </a>
  
    <a target="_blank"
       class="main" 
       href="http://github.com/denger">
       GitHub
     </a>
  
</div>
      <section class="paging">
  
    <div class="left">
      <a href="/2011/05/10/sina-weibo-for-sso-principle/">
        ‹
      </a>
    </div>
  
  
    <div class="right">
      <a href="/2011/06/16/python-skills/">
        ›
      </a>
    </div>
  
</section>
      <div class="content">
        <section class='post'>
          <h1 class="upcase">
            <div class='date'>27 May 2011</div>
            MyBatis+Spring 基于接口编程的原理分析
          </h1>
          <h5 id="spring3mybatis3">整合Spring3及MyBatis3</h5>

<p>对于整合Spring及Mybatis不作详细介绍，可以参考： <a href="http://www.google.com.hk/url?sa=t&amp;rct=j&amp;q=MyBatis+3+User+Guide+Simplified+Chinese.pdf&amp;source=web&amp;cd=2&amp;ved=0CDkQFjAB&amp;url=http%3A%2F%2Fmybatis.googlecode.com%2Ffiles%2FMyBatis-3-User-Guide-Simplified-Chinese.pdf&amp;ei=_mlZUdmSPMWpiAf4uYHIDw&amp;usg=AFQjCNHAL9KPhzfilVnZloJ-yZZ2tXWeYQ&amp;bvm=bv.44442042,d.dGI">MyBatis 3 User Guide Simplified Chinese.pdf</a>，贴出我的主要代码如下：</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">denger</span><span class="o">.</span><span class="na">mapper</span><span class="o">;</span>  
  
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Param</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Select</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">org.denger.po.User</span><span class="o">;</span>  
  
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserMapper</span> <span class="o">{</span>  
  
    <span class="nd">@Select</span><span class="o">(</span><span class="s">"select * from tab_uc_account where id=#{userId}"</span><span class="o">)</span>  
    <span class="n">User</span> <span class="n">getUser</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"userId"</span><span class="o">)</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">);</span>  
<span class="o">}</span> </code></pre></figure>

<h5 id="application-contextxml">application-context.xml</h5>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>  
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>  
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>  
    <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span> <span class="na">xmlns:tx=</span><span class="s">"http://www.springframework.org/schema/tx"</span>  
    <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.0.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.0.xsd"</span><span class="nt">&gt;</span>  
  
  
    <span class="c">&lt;!-- Provided by annotation-based configuration  --&gt;</span>  
    <span class="nt">&lt;context:annotation-config/&gt;</span>  
  
    <span class="c">&lt;!--JDBC Transaction  Manage --&gt;</span>  
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSourceProxy"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.datasource.TransactionAwareDataSourceProxy"</span><span class="nt">&gt;</span>  
        <span class="nt">&lt;constructor-arg&gt;</span>  
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">"dataSource"</span> <span class="nt">/&gt;</span>  
        <span class="nt">&lt;/constructor-arg&gt;</span>  
    <span class="nt">&lt;/bean&gt;</span>  
  
    <span class="c">&lt;!-- The JDBC c3p0 dataSource bean--&gt;</span>  
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span> <span class="na">class=</span><span class="s">"com.mchange.v2.c3p0.ComboPooledDataSource"</span> <span class="na">destroy-method=</span><span class="s">"close"</span><span class="nt">&gt;</span>  
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driverClass"</span> <span class="na">value=</span><span class="s">"com.mysql.jdbc.Driver"</span> <span class="nt">/&gt;</span>  
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jdbcUrl"</span> <span class="na">value=</span><span class="s">"jdbc:mysql://127.0.0.1:3306/noah"</span> <span class="nt">/&gt;</span>  
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"user"</span> <span class="na">value=</span><span class="s">"root"</span> <span class="nt">/&gt;</span>  
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"123456"</span> <span class="nt">/&gt;</span>  
    <span class="nt">&lt;/bean&gt;</span>  
  
    <span class="c">&lt;!--MyBatis integration with Spring as define sqlSessionFactory  --&gt;</span>  
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"sqlSessionFactory"</span> <span class="na">class=</span><span class="s">"org.mybatis.spring.SqlSessionFactoryBean"</span><span class="nt">&gt;</span>  
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span> <span class="nt">/&gt;</span>  
    <span class="nt">&lt;/bean&gt;</span>  
  
    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span><span class="nt">&gt;</span>  
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"sqlSessionFactory"</span>  <span class="na">ref=</span><span class="s">"sqlSessionFactory"</span><span class="nt">/&gt;</span>  
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"basePackage"</span> <span class="na">value=</span><span class="s">"org.denger.mapper"</span><span class="nt">&gt;&lt;/property&gt;</span>  
    <span class="nt">&lt;/bean&gt;</span>  
<span class="nt">&lt;/beans&gt;</span></code></pre></figure>

<h5 id="test-case">Test Case</h5>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">denger</span><span class="o">.</span><span class="na">mapper</span><span class="o">;</span>  
  
<span class="kn">import</span> <span class="nn">org.junit.Assert</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">org.springframework.test.context.ContextConfiguration</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.AbstractJUnit4SpringContextTests</span><span class="o">;</span>  
  
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="n">locations</span> <span class="o">=</span> <span class="o">{</span> <span class="s">"/application-context.xml"</span><span class="o">})</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserMapperTest</span> <span class="kd">extends</span> <span class="n">AbstractJUnit4SpringContextTests</span><span class="o">{</span>  
  
    <span class="nd">@Autowired</span>  
    <span class="kd">public</span> <span class="n">UserMapper</span> <span class="n">userMapper</span><span class="o">;</span>  
      
    <span class="nd">@Test</span>  
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">testGetUser</span><span class="o">(){</span>  
        <span class="n">Assert</span><span class="o">.</span><span class="na">assertNotNull</span><span class="o">(</span><span class="n">userMapper</span><span class="o">.</span><span class="na">getUser</span><span class="o">(</span><span class="mi">300L</span><span class="o">));</span>  
    <span class="o">}</span>  
<span class="o">}</span> </code></pre></figure>

<h5 id="section">实现原理分析</h5>
<p>对于以上极其简单代码看上去并无特殊之处，主要亮点在于 UserMapper 居然不用实现类，而且在调用 getUser 的时候，也是使用直接调用了UserMapper实现类，那么Mybatis是如何去实现 UserMapper的接口的呢？ 可能你马上能想到的实现机制就是通过<a href="http://hi.baidu.com/erics_lele/blog/item/4717dbea081421d0d439c91b.html">动态代理</a>方式，好吧，看看MyBatis整个的代理过程吧。</p>

<p>首先在Spring的配置文件中看到下面的Bean：</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span><span class="nt">&gt;</span>  
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"sqlSessionFactory"</span>  <span class="na">ref=</span><span class="s">"sqlSessionFactory"</span><span class="nt">/&gt;</span>  
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"basePackage"</span> <span class="na">value=</span><span class="s">"org.denger.mapper"</span><span class="nt">&gt;&lt;/property&gt;</span>  
<span class="nt">&lt;/bean&gt;</span> </code></pre></figure>

<p>以上的MapperScannerConfigurer class的注释中描述道：
&gt; 从base 包中搜索所有下面所有 interface，并将其注册到 Spring Bean容器中，其注册的class bean是MapperFactoryBean。</p>

<p>好吧，看看它的注册过程，下面方法来从　MapperScannerConfigurer中的Scanner类中抽取，下面方法在初始化以上application-content.xml文件时就会进行调用。　主要用于是搜索 base packages 下的所有mapper class,并将其注册至 spring 的 benfinitionHolder中。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/** 
* Calls the parent search that will search and register all the candidates. Then the 
* registered objects are post processed to set them as MapperFactoryBeans 
*/</span>  
<span class="nd">@Override</span>  
<span class="kd">protected</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">doScan</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">basePackages</span><span class="o">)</span> <span class="o">{</span>  
    <span class="c1">//#1  </span>
    <span class="n">Set</span><span class="o">&lt;</span><span class="n">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">beanDefinitions</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">doScan</span><span class="o">(</span><span class="n">basePackages</span><span class="o">);</span>  
    <span class="k">if</span> <span class="o">(</span><span class="n">beanDefinitions</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>  
            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"No MyBatis mapper was found in '"</span> <span class="o">+</span> <span class="n">MapperScannerConfigurer</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">basePackage</span>  
                        <span class="o">+</span> <span class="s">"' package. Please check your configuration."</span><span class="o">);</span>  
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>  
         <span class="c1">//#2  </span>
         <span class="k">for</span> <span class="o">(</span><span class="n">BeanDefinitionHolder</span> <span class="n">holder</span> <span class="o">:</span> <span class="n">beanDefinitions</span><span class="o">)</span> <span class="o">{</span>  
                <span class="n">GenericBeanDefinition</span> <span class="n">definition</span> <span class="o">=</span> <span class="o">(</span><span class="n">GenericBeanDefinition</span><span class="o">)</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">();</span>  
            <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>  
                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Creating MapperFactoryBean with name '"</span> <span class="o">+</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"' and '"</span><span class="o">+</span> <span class="n">definition</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"' mapperInterface"</span><span class="o">);</span>  
            <span class="o">}</span>  
           <span class="c1">//#3  </span>
          <span class="n">definition</span><span class="o">.</span><span class="na">getPropertyValues</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"mapperInterface"</span><span class="o">,</span> <span class="n">definition</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">());</span>  
          <span class="n">definition</span><span class="o">.</span><span class="na">setBeanClass</span><span class="o">(</span><span class="n">MapperFactoryBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>  
     <span class="o">}</span>  
    <span class="k">return</span> <span class="n">beanDefinitions</span><span class="o">;</span>  
<span class="o">}</span>  </code></pre></figure>

<p>#1: 了解Spring初始化Bean过程的人可能都知道，Spring 首先会将需要初始化的所有class先通过BeanDefinitionRegistry进行注册，并且将该Bean的一些属性信息(如scope、className、beanName等)保存至BeanDefinitionHolder中；Mybatis这里首先会调用Spring中的ClassPathBeanDefinitionScanner.doScan方法，将所有Mapper接口的class注册至BeanDefinitionHolder实例中，然后返回一个Set<BeanDefinitionHolder>，其它包含了所有搜索到的Mapper class BeanDefinitionHolder对象。</BeanDefinitionHolder></p>

<p>#2: 首先，由于 #1 中注册的都是接口class， 可以肯定的是接口是不能直接初始化的；实际 #2 中for循环中替换当前所有 holder的 className为 MapperFactoryBean.class，并且将 mapper interface的class name setter 至 MapperFactoryBean 属性为 mapperInterface 中，也就是 #3 代码所看到的。</p>

<p>再看看 MapperFactoryBean，它是直接实现了 Spring 的　FactoryBean及InitializingBean　接口。其实既使不看这两个接口，当看MapperFactoryBean的classname就知道它是一个专门用于创建 Mapper 实例Bean的工厂。</p>

<p>至此，已经完成了Spring与mybatis的整合的初始化配置的过程。</p>

<p>接着，当我在以上的 Test类中，需要注入 UserMapper接口实例时，由于mybatis给所有的Mapper 实例注册都是一个MapperFactory的工厂，所以产生UserMapper实现仍需要 MapperFactoryBean来进行创建。接下来看看 MapperFactoryBean的处理过程。</p>

<p>先需要创建Mapper实例时，首先在 MapperFactoryBean中执行的方法是：</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/** 
 * {@inheritDoc} 
 */</span>  
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="p">(</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>  
    <span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">sqlSession</span><span class="o">,</span> <span class="s">"Property 'sqlSessionFactory' or 'sqlSessionTemplate' are required"</span><span class="o">);</span>  
    <span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mapperInterface</span><span class="o">,</span> <span class="s">"Property 'mapperInterface' is required"</span><span class="o">);</span>  

    <span class="n">Configuration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">sqlSession</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">();</span>  
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">addToConfig</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">configuration</span><span class="o">.</span><span class="na">hasMapper</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mapperInterface</span><span class="o">))</span> <span class="o">{</span>  
        <span class="n">configuration</span><span class="o">.</span><span class="na">addMapper</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mapperInterface</span><span class="o">);</span>  
    <span class="o">}</span>  
<span class="o">}</span> </code></pre></figure>

<p>上面方法中先会检测当前需要创建的 mapperInterface在全局的 Configuration中是否存在，如果不存在则添加。呆会再说他为什么要将 mapperInterface 添加至 Configuration中。该方法调用完成之后，就开始调用 getObject方法来产生mapper实例，看到MapperFactoryBean.getObject的该方法代码如下：</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/** 
 * {@inheritDoc} 
 */</span>  
<span class="kd">public</span> <span class="n">T</span> <span class="nf">getObject</span><span class="p">(</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>  
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">sqlSession</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mapperInterface</span><span class="o">);</span>  
<span class="o">}</span></code></pre></figure>

<p>通过Debug可以看到 sqlSession及mapperInterface对象：</p>

<p><img src="/images/2011/05/27/1.png" alt="alt &quot;DEBUG IMAGE&quot;" /></p>

<p>到目前为止我们的 UserMapper 实例实际上还并未产生；再进入 org.mybatis.spring.SqlSessionTemplate 中的 getMapper 方法，该方法将 this 及 mapper interface class 作为参数传入 org.apache.ibatis.session.Configuration的getMapper() 方法中，代码如下：</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/** 
 * {@inheritDoc} 
 */</span>  
<span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">getMapper</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>  
    <span class="k">return</span> <span class="n">getConfiguration</span><span class="o">().</span><span class="na">getMapper</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>  
<span class="o">}</span></code></pre></figure>

<p>于是，再进入 org.apache.ibatis.session.Configuration.getMapper 中代码如下：</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">getMapper</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">,</span> <span class="n">SqlSession</span> <span class="n">sqlSession</span><span class="o">)</span> <span class="o">{</span>  
    <span class="k">return</span> <span class="n">mapperRegistry</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">sqlSession</span><span class="o">);</span>  
<span class="o">}</span> </code></pre></figure>

<p>其中 mapperRegistry保存着当前所有的 mapperInterface class.　那么它在什么时候将 mapperinterface class 保存进入的呢？其实就是在上面的 afterPropertiesSet 中通过 configuration.addMapper(this.mapperInterface) 添加进入的。</p>

<p>再进入 org.apache.ibatis.binding.MapperRegistry.getMapper 方法，代码如下：</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="o">/**</span> 
<span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">getMapper</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">,</span> <span class="n">SqlSession</span> <span class="n">sqlSession</span><span class="o">)</span> <span class="o">{</span>  
  <span class="c1">//首先判断当前knownMappers是否存在mapper interface class. </span>
  <span class="c1">//因为前面说到 afterPropertiesSet 中已经将当前的 mapperinterfaceclass 添加进入了。  </span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">knownMappers</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">type</span><span class="o">))</span>  
    <span class="k">throw</span> <span class="k">new</span> <span class="n">BindingException</span><span class="o">(</span><span class="s">"Type "</span> <span class="o">+</span> <span class="n">type</span> <span class="o">+</span> <span class="s">" is not known to the MapperRegistry."</span><span class="o">);</span>  
  <span class="k">try</span> <span class="o">{</span>  
    <span class="k">return</span> <span class="n">MapperProxy</span><span class="o">.</span><span class="na">newMapperProxy</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">sqlSession</span><span class="o">);</span>  
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>  
    <span class="k">throw</span> <span class="k">new</span> <span class="n">BindingException</span><span class="o">(</span><span class="s">"Error getting mapper instance. Cause: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>  
  <span class="o">}</span>  
<span class="o">}</span></code></pre></figure>

<p>嗯，没错，看到　MapperProxy.newMapperProxy后可以肯定的是它确实采用的代理模式，再进入一看究竟吧：</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">newMapperProxy</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">mapperInterface</span><span class="o">,</span> <span class="n">SqlSession</span> <span class="n">sqlSession</span><span class="o">)</span> <span class="o">{</span>  
    <span class="n">ClassLoader</span> <span class="n">classLoader</span> <span class="o">=</span> <span class="n">mapperInterface</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">();</span>  
    <span class="n">Class</span><span class="o">[]</span> <span class="n">interfaces</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">mapperInterface</span><span class="o">};</span>  
    <span class="n">MapperProxy</span> <span class="n">proxy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MapperProxy</span><span class="o">(</span><span class="n">sqlSession</span><span class="o">);</span>  
    <span class="k">return</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">classLoader</span><span class="o">,</span> <span class="n">interfaces</span><span class="o">,</span> <span class="n">proxy</span><span class="o">);</span>  
  <span class="o">}</span></code></pre></figure>

<p>JDK的动态代理就不说了，至此，基本Mybatis已经完成了Mapper实例的整个创建过程，也就是你在具体使用 UserMapper.getUser 时，它实际上调用的是 MapperProxy，因为此时 所返回的 MapperProxy是实现了 UserMapper接口的。只不过 MapperProxy拦截了所有对userMapper中方法的调用，如下：</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>  
   <span class="k">try</span> <span class="o">{</span>  
    <span class="c1">//如果调用不是 object 中默认的方法(如equals之类的)  </span>
     <span class="k">if</span> <span class="o">(!</span><span class="n">OBJECT_METHODS</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>  
       <span class="c1">//因为当前MapperProxy代理了所有 Mapper，所以他需要根据当前拦截到的方法及代理对象获取 MapperInterface  class，也就是我这里的 UserMapper.class  </span>
       <span class="kd">final</span> <span class="n">Class</span> <span class="n">declaringInterface</span> <span class="o">=</span> <span class="n">findDeclaringInterface</span><span class="o">(</span><span class="n">proxy</span><span class="o">,</span> <span class="n">method</span><span class="o">);</span>  
       <span class="c1">//然后再根据UserMapper.class、及当前调用的Method(也就是getUser)及SqlSession构造一个 MapperMethod，在这里面会获取到 getUser方法上的 @Select() 的SQL，然后再通过 sqlSession来进行执行  </span>
       <span class="kd">final</span> <span class="n">MapperMethod</span> <span class="n">mapperMethod</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MapperMethod</span><span class="o">(</span><span class="n">declaringInterface</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">sqlSession</span><span class="o">);</span>  
       <span class="c1">//execute执行数据库操作，并返回结果集  </span>
       <span class="kd">final</span> <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mapperMethod</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>  
       <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">().</span><span class="na">isPrimitive</span><span class="o">())</span> <span class="o">{</span>  
         <span class="k">throw</span> <span class="k">new</span> <span class="n">BindingException</span><span class="o">(</span><span class="s">"Mapper method '"</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"' ("</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">()</span> <span class="o">+</span> <span class="s">") attempted to return null from a method with a primitive return type ("</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">()</span> <span class="o">+</span> <span class="s">")."</span><span class="o">);</span>  
       <span class="o">}</span>  
       <span class="k">return</span> <span class="n">result</span><span class="o">;</span>  
     <span class="o">}</span>  
   <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>  
     <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>  
   <span class="o">}</span>  
   <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>  
 <span class="o">}</span> </code></pre></figure>

<p>为什么说它拦截了呢？可以看到, 它并没有调用 method.invoke(object)方法，因为实际上 MapperProxy只是动态的 implement 了UserMapper接口，但它没有真正实现 UserMapper中的任何方法。至于结果的返回，它也是通过 MapperMethod.execute 中进行数据库操作来返回结果的。说白了，就是一个实现了 MapperInterface 的 MapperProxy 实例被MapperProxy代理了，可以debug看看　userMapper实例就是 MapperProxy。</p>

<p>–</p>

          <br />
<p>
  Til next time,<br/>
  Denger
  <span class="muted">at 00:00</span>
</p>
<p>
  <img src="/images/scribble3.png" alt="scribble" /> 
</p>


        </section>
      </div>
      

      
      <div class="block">
  
    <a target="_blank"
       class="main" 
       href="/about">
       About
     </a>
  
    <a target="_blank"
       class="main" 
       href="http://github.com/denger">
       GitHub
     </a>
  
</div>
    </div>
    <footer>
  <a href="http://github.com/muan/scribble" class="muted">built with Jekyll using Scribble theme</a>
  <br />
  <br />
  <img src="/images/scribble2.png" alt="scribble" /> 
</footer>
  </body>
</html>
